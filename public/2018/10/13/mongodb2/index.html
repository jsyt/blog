<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>GOYTH  | MongoDB 知识点梳理(二)</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.65.3" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.1cb140d8ba31d5b2f1114537dd04802a.css" rel="stylesheet">
    

    

    
      
<link rel="shortcut icon" href="/https://img-1256541035.cos.ap-shanghai.myqcloud.com/imgs/favicon-red-bird.png" type="image/x-icon" />

    

    
    
    <meta property="og:title" content="MongoDB 知识点梳理(二)" />
<meta property="og:description" content="MongoDB 知识点梳理（二）" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://goyth.cn/2018/10/13/mongodb2/" />
<meta property="article:published_time" content="2018-10-13T21:53:54+08:00" />
<meta property="article:modified_time" content="2018-10-13T21:53:54+08:00" />
<meta itemprop="name" content="MongoDB 知识点梳理(二)">
<meta itemprop="description" content="MongoDB 知识点梳理（二）">
<meta itemprop="datePublished" content="2018-10-13T21:53:54&#43;08:00" />
<meta itemprop="dateModified" content="2018-10-13T21:53:54&#43;08:00" />
<meta itemprop="wordCount" content="730">



<meta itemprop="keywords" content="Database,MongoDB," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MongoDB 知识点梳理(二)"/>
<meta name="twitter:description" content="MongoDB 知识点梳理（二）"/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://goyth.cn/" class="f3 fw2 hover-white no-underline white-90 dib">
      GOYTH
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="About page">
              About
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Articles page">
              Articles
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/contact/" title="Contact page">
              Contact
            </a>
          </li>
          
        </ul>
      
      




<a href="https://twitter.com/goythz" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>





<a href="https://github.com/jsyt" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>







    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        ARTICLES
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://goyth.cn/2018/10/13/mongodb2/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://goyth.cn/2018/10/13/mongodb2/&amp;text=MongoDB%20%e7%9f%a5%e8%af%86%e7%82%b9%e6%a2%b3%e7%90%86%28%e4%ba%8c%29" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://goyth.cn/2018/10/13/mongodb2/&amp;title=MongoDB%20%e7%9f%a5%e8%af%86%e7%82%b9%e6%a2%b3%e7%90%86%28%e4%ba%8c%29" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>

      <h1 class="f1 athelas mt3 mb1">MongoDB 知识点梳理(二)</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2018-10-13T21:53:54&#43;08:00">October 13, 2018</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy avenir bg-near-white f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h3 id="mongodb通过配置项启动数据库">MongoDB通过配置项启动数据库</h3>
<h4 id="启动服务器">启动服务器</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mongod --config mongo.conf
</code></pre></div><h4 id="启动客户端">启动客户端</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mongo --port <span style="color:#bd93f9">50000</span>
</code></pre></div><table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">&ndash;dbpath</td>
<td align="center">指定数据库文件的目录</td>
</tr>
<tr>
<td align="center">&ndash;port</td>
<td align="center">端口 默认是27017 28017</td>
</tr>
<tr>
<td align="center">&ndash;fork</td>
<td align="center">以后台守护的方式进行启动</td>
</tr>
<tr>
<td align="center">&ndash;logpath</td>
<td align="center">指定日志文件输出路径</td>
</tr>
<tr>
<td align="center">&ndash;config</td>
<td align="center">指定一个配置文件</td>
</tr>
<tr>
<td align="center">&ndash;auth</td>
<td align="center">以安全方式启动数据库，默认不验证</td>
</tr>
</tbody>
</table>
<h4 id="mongoconf">mongo.conf</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#8be9fd;font-style:italic">dbpath</span><span style="color:#ff79c6">=</span>/Users/demon/coding/mongo/data
<span style="color:#8be9fd;font-style:italic">logpath</span><span style="color:#ff79c6">=</span>/Users/demon/coding/mongo/log
<span style="color:#8be9fd;font-style:italic">port</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">50000</span>
</code></pre></div><h3 id="导入导出数据">导入导出数据</h3>
<p>这命令是保存成了文件格式</p>
<ul>
<li>mongoimport 导出数据</li>
<li>mongoexport 导入数据</li>
</ul>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">-h</td>
<td align="center">[ &ndash;host ]	连接的数据库</td>
<td></td>
</tr>
<tr>
<td align="center">&ndash;port</td>
<td align="center">端口号</td>
<td></td>
</tr>
<tr>
<td align="center">-u</td>
<td align="center">用户名</td>
<td></td>
</tr>
<tr>
<td align="center">-p</td>
<td align="center">密码</td>
<td></td>
</tr>
<tr>
<td align="center">-d</td>
<td align="center">导出的数据库</td>
<td></td>
</tr>
<tr>
<td align="center">-d</td>
<td align="center">导出的数据库</td>
<td></td>
</tr>
<tr>
<td align="center">-c</td>
<td align="center">指定导出的集合</td>
<td></td>
</tr>
<tr>
<td align="center">-o</td>
<td align="center">导出的文件存储路径</td>
<td></td>
</tr>
<tr>
<td align="center">-q</td>
<td align="center">进行过滤</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>准备数据</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">use school;
<span style="color:#8be9fd;font-style:italic">var</span> students <span style="color:#ff79c6">=</span> [];
<span style="color:#ff79c6">for</span>(<span style="color:#8be9fd;font-style:italic">var</span> i<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>;i<span style="color:#ff79c6">&lt;=</span><span style="color:#bd93f9">10</span>;i<span style="color:#ff79c6">++</span>){
    students.push({name<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;luke&#39;</span><span style="color:#ff79c6">+</span>i,age<span style="color:#ff79c6">:</span>i});
}
db.students.insert(students);
db.students.find();
</code></pre></div><p><strong>备份记录</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">mongoexport <span style="color:#ff79c6">-</span>h <span style="color:#bd93f9">127.0.0.1</span> <span style="color:#ff79c6">--</span>port <span style="color:#bd93f9">50000</span>  <span style="color:#ff79c6">-</span>d school <span style="color:#ff79c6">-</span>c students <span style="color:#ff79c6">-</span>o stu.json
</code></pre></div><p><strong>删除记录</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.students.remove<span style="color:#ff79c6">({})</span>;
WriteResult<span style="color:#ff79c6">({</span> <span style="color:#f1fa8c">&#34;nRemoved&#34;</span> : <span style="color:#bd93f9">10</span> <span style="color:#ff79c6">})</span>
</code></pre></div><p><strong>导入记录</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">mongoimport <span style="color:#ff79c6">--</span>port <span style="color:#bd93f9">50000</span> <span style="color:#ff79c6">--</span>db school <span style="color:#ff79c6">--</span>collection students <span style="color:#ff79c6">--</span>file
stu.json
</code></pre></div><h3 id="备份与恢复">备份与恢复</h3>
<h4 id="mongodump">mongodump</h4>
<p>在Mongodb中我们使用mongodump命令来备份MongoDB数据。该命令可以导出所有数据到指定目录中。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">mongodump <span style="color:#ff79c6">-</span>h dbhost <span style="color:#ff79c6">-</span>d dbname <span style="color:#ff79c6">-</span>o dbdirectory
</code></pre></div><ul>
<li>-h MongDB所在服务器地址，例如：127.0.0.1，当然也可以指定端口号：127.0.0.1:27017</li>
<li>-d 需要备份的数据库实例，例如：test</li>
<li>-o 备份的数据存放位置</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">mongodump <span style="color:#ff79c6">-</span>h <span style="color:#bd93f9">127.0.0.1</span> <span style="color:#ff79c6">--</span>port <span style="color:#bd93f9">50000</span> <span style="color:#ff79c6">-</span>d school <span style="color:#ff79c6">-</span>o data.dmp
</code></pre></div><h4 id="mongorestore">mongorestore</h4>
<p><strong>mongodb</strong>使用 <strong>mongorestore</strong> 命令来恢复备份的数据。</p>
<ul>
<li>&ndash;host MongoDB所在服务器地址</li>
<li>&ndash;db -d 需要恢复的数据库实例</li>
<li>最后的一个参数，设置备份数据所在位置</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">mongorestore <span style="color:#ff79c6">-</span>h <span style="color:#bd93f9">127.0.0.1</span> <span style="color:#ff79c6">--</span>port <span style="color:#bd93f9">50000</span> data.dmp
mongorestore <span style="color:#ff79c6">-</span>h <span style="color:#bd93f9">127.0.0.1</span> <span style="color:#ff79c6">--</span>port <span style="color:#bd93f9">50000</span> <span style="color:#ff79c6">-</span>d school data.bmp<span style="color:#ff79c6">/</span>school
</code></pre></div><blockquote>
<p>Mongodump可以backup整个数据库，而mongoexport要对每个collection进行操作，最主要的区别也是选择的标准是mongoexport输出的JSON比Mongodump的BSON可读性更高，进而可以直接对JSON文件进行操作然后还原数据（BSON转换JSON存在潜在兼容问题）。</p>
</blockquote>
<h3 id="锁定和解锁数据库">锁定和解锁数据库</h3>
<p>为了数据的完整性和一致性，导出前要先锁定写入，导出后再解锁。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; use admin;
switched to db admin
&gt; db.runCommand<span style="color:#ff79c6">({</span>fsync:1,lock:1<span style="color:#ff79c6">})</span>;
<span style="color:#ff79c6">{</span>
        <span style="color:#f1fa8c">&#34;info&#34;</span> : <span style="color:#f1fa8c">&#34;now locked against writes, use db.fsyncUnlock() to unlock&#34;</span>,
        <span style="color:#f1fa8c">&#34;seeAlso&#34;</span> : <span style="color:#f1fa8c">&#34;http://dochub.mongodb.org/core/fsynccommand&#34;</span>,
        <span style="color:#f1fa8c">&#34;ok&#34;</span> : <span style="color:#bd93f9">1</span>
<span style="color:#ff79c6">}</span>
&gt; db.fsyncUnlock<span style="color:#ff79c6">()</span>;
<span style="color:#ff79c6">{</span> <span style="color:#f1fa8c">&#34;ok&#34;</span> : 1, <span style="color:#f1fa8c">&#34;info&#34;</span> : <span style="color:#f1fa8c">&#34;unlock completed&#34;</span> <span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="用户管理">用户管理</h3>
<h4 id="查看角色">查看角色</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">show roles;
</code></pre></div><h4 id="内置角色">内置角色</h4>
<ul>
<li>数据库用户角色：read、readWrite；</li>
<li>数据库管理角色：dbAdmin、dbOwner、userAdmin;</li>
<li>集群管理角色：clusterAdmin、clusterManager、clusterMonitor、hostManage；</li>
<li>备份恢复角色：backup、restore；</li>
<li>所有数据库角色：readAnyDatabase、readWriteAnyDatabase、userAdminAnyDatabase、dbAdminAnyDatabase</li>
<li>超级用户角色：root</li>
<li>内部角色：__system</li>
</ul>
<h4 id="创建用户的方法">创建用户的方法</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.createUser<span style="color:#ff79c6">({</span>user:<span style="color:#f1fa8c">&#39;luke2&#39;</span>,pwd:<span style="color:#f1fa8c">&#39;123456&#39;</span>,roles:<span style="color:#ff79c6">[{</span>role:<span style="color:#f1fa8c">&#39;read&#39;</span>,db:<span style="color:#f1fa8c">&#39;school&#39;</span><span style="color:#ff79c6">}]})</span>;
Successfully added user: <span style="color:#ff79c6">{</span>
        <span style="color:#f1fa8c">&#34;user&#34;</span> : <span style="color:#f1fa8c">&#34;luke2&#34;</span>,
        <span style="color:#f1fa8c">&#34;roles&#34;</span> : <span style="color:#ff79c6">[</span>
                <span style="color:#ff79c6">{</span>
                        <span style="color:#f1fa8c">&#34;role&#34;</span> : <span style="color:#f1fa8c">&#34;read&#34;</span>,
                        <span style="color:#f1fa8c">&#34;db&#34;</span> : <span style="color:#f1fa8c">&#34;school&#34;</span>
                <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">]</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="查看用户的权限">查看用户的权限</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#ff79c6">&gt;</span> db.runCommand({usersInfo<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;luke2&#39;</span>,showPrivileges<span style="color:#ff79c6">:</span><span style="color:#ff79c6">true</span>});
{
        <span style="color:#f1fa8c">&#34;users&#34;</span> <span style="color:#ff79c6">:</span> [
                {
                        <span style="color:#f1fa8c">&#34;_id&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;admin.luke2&#34;</span>,
                        <span style="color:#f1fa8c">&#34;user&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;luke2&#34;</span>,
                        <span style="color:#f1fa8c">&#34;db&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;admin&#34;</span>,
                        <span style="color:#f1fa8c">&#34;roles&#34;</span> <span style="color:#ff79c6">:</span> [
                                {
                                        <span style="color:#f1fa8c">&#34;role&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;read&#34;</span>,
                                        <span style="color:#f1fa8c">&#34;db&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;school&#34;</span>
                                }
                ]
}
</code></pre></div><h3 id="数据库高级命令">数据库高级命令</h3>
<h4 id="准备数据">准备数据</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8be9fd;font-style:italic">var</span> students <span style="color:#ff79c6">=</span> [
        {name<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;luke1&#39;</span>,home<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;北京&#39;</span>,age<span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>},
        {name<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;luke2&#39;</span>,home<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;北京&#39;</span>,age<span style="color:#ff79c6">:</span><span style="color:#bd93f9">2</span>},
        {name<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;luke3&#39;</span>,home<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;北京&#39;</span>,age<span style="color:#ff79c6">:</span><span style="color:#bd93f9">3</span>},
        {name<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;luke4&#39;</span>,home<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;广东&#39;</span>,age<span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>},
        {name<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;luke5&#39;</span>,home<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;广东&#39;</span>,age<span style="color:#ff79c6">:</span><span style="color:#bd93f9">2</span>},
        {name<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;luke6&#39;</span>,home<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;广东&#39;</span>,age<span style="color:#ff79c6">:</span><span style="color:#bd93f9">3</span>}
]
db.students.insert(students);
</code></pre></div><h4 id="count">count</h4>
<p>查看记录数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.students.find().count();
</code></pre></div><h4 id="查找不重复的值-distinct">查找不重复的值 distinct</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.runCommand({distinct<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;students&#39;</span>,key<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;home&#39;</span>}).values;

<span style="color:#6272a4">//[ &#34;北京&#34;, &#34;广东&#34; ]
</span></code></pre></div><h4 id="group-分组">group 分组</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.runCommand({
        group<span style="color:#ff79c6">:</span>{
                ns<span style="color:#ff79c6">:</span>集合名称，
                key<span style="color:#ff79c6">:</span>分组的键,
                initial<span style="color:#ff79c6">:</span>初始值,
                $reduce<span style="color:#ff79c6">:</span>分解器
                condition<span style="color:#ff79c6">:</span>条件,
                finalize<span style="color:#ff79c6">:</span>完成时的处理器
        }
});
</code></pre></div><h4 id="按城市分组求每个城市里符合条件的人的年龄总和">按城市分组，求每个城市里符合条件的人的年龄总和</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.runCommand({
        group<span style="color:#ff79c6">:</span>{
                ns<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;students&#39;</span>,
                key<span style="color:#ff79c6">:</span>{home<span style="color:#ff79c6">:</span><span style="color:#ff79c6">true</span>},
                initial<span style="color:#ff79c6">:</span>{total<span style="color:#ff79c6">:</span><span style="color:#bd93f9">0</span>},
                $reduce<span style="color:#ff79c6">:</span><span style="color:#8be9fd;font-style:italic">function</span>(doc,result){
                      result.total <span style="color:#ff79c6">+=</span> doc.age;
                },
                condition<span style="color:#ff79c6">:</span>{age<span style="color:#ff79c6">:</span>{$gt<span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>}},
                finalize<span style="color:#ff79c6">:</span><span style="color:#8be9fd;font-style:italic">function</span>(result){
                    result.desc <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;本城市的总年龄为&#39;</span><span style="color:#ff79c6">+</span>result.total;
                }
        }
});
</code></pre></div><h4 id="删除集合">删除集合</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.runCommand({drop<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;students&#39;</span>});
</code></pre></div><h3 id="固定集合">固定集合</h3>
<p>MongoDB 固定集合（Capped Collections）是性能出色且有着固定大小的集合，对于大小固定，我们可以想象其就像一个环形队列，当集合空间用完后，再插入的元素就会覆盖最初始的头部的元素！ firstinfirstout</p>
<h4 id="特性">特性</h4>
<ul>
<li>没有索引</li>
<li>插入和查询速度速度非常快 不需要重新分配空间</li>
<li>特别适合存储日志</li>
</ul>
<h4 id="创建固定集合">创建固定集合</h4>
<ul>
<li>我们通过createCollection来创建一个固定集合，且capped选项设置为true：</li>
<li>还可以指定文档个数,加上max:1000属性：</li>
<li>判断集合是否为固定集合: db.logs.isCapped()</li>
<li>size 是整个集合空间大小，单位为【KB】</li>
<li>max 是集合文档个数上线，单位是【个】</li>
<li>如果空间大小到达上限，则插入下一个文档时，会覆盖第一个文档；如果文档个数到达上限，同样插入下一个文档时，会覆盖第一个文档。两个参数上限判断取的是【与】的逻辑。</li>
<li>capped 封顶的</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"> db.createCollection(<span style="color:#f1fa8c">&#39;logs&#39;</span>,{size<span style="color:#ff79c6">:</span><span style="color:#bd93f9">50</span>,max<span style="color:#ff79c6">:</span><span style="color:#bd93f9">5</span>,capped<span style="color:#ff79c6">:</span><span style="color:#ff79c6">true</span>});
</code></pre></div><h4 id="非固定集合转为固定集合">非固定集合转为固定集合</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.runCommand({convertToCapped<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;logs&#34;</span>,size<span style="color:#ff79c6">:</span><span style="color:#bd93f9">5</span>});
</code></pre></div><h3 id="索引">索引</h3>
<ul>
<li>索引通常能够极大的提高查询的效率，如果没有索引，MongoDB在读取数据时必须扫描集合中的每个文件并选取那些符合查询条件的记录。</li>
<li>这种扫描全集合的查询效率是非常低的，特别在处理大量的数据时，查询可以要花费几十秒甚至几分钟，这对网站的性能是非常致命的。</li>
<li>索引是特殊的数据结构，索引存储在一个易于遍历读取的数据集合中，索引是对数据库表中一列或多列的值进行排序的一种结构</li>
<li>使用索引，方便范围查询和匹配查询。</li>
</ul>
<h4 id="createindex-方法">createIndex() 方法</h4>
<p>MongoDB使用 createIndex() 方法来创建索引。</p>
<blockquote>
<p>注意在 3.0.0 版本前创建索引方法为 db.collection.ensureIndex()，之后的版本使用了 db.collection.createIndex() 方法，ensureIndex() 还能用，但只是 createIndex() 的别名。</p>
</blockquote>
<p><strong>语法</strong>
createIndex()方法基本语法格式如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.collection.createIndex(keys, options)
</code></pre></div><p>语法中 Key 值为你要创建的索引字段，1 为指定按升序创建索引，如果你想按降序来创建索引指定为 -1 即可。</p>
<p><strong>实例</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.col.createIndex({<span style="color:#f1fa8c">&#34;title&#34;</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>})
</code></pre></div><p>createIndex() 方法中你也可以设置使用多个字段创建索引（关系型数据库中称作复合索引）。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.col.createIndex({<span style="color:#f1fa8c">&#34;title&#34;</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>,<span style="color:#f1fa8c">&#34;description&#34;</span><span style="color:#ff79c6">:-</span><span style="color:#bd93f9">1</span>})
</code></pre></div><h4 id="指定使用的索引">指定使用的索引</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.students.find({name<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;zfpx299999&#39;</span>,age<span style="color:#ff79c6">:</span><span style="color:#bd93f9">299999</span>}).hint({name<span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>}).explain(<span style="color:#ff79c6">true</span>);
</code></pre></div><h4 id="创建唯一索引并删除重复记录">创建唯一索引并删除重复记录</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.person.ensureIndex({ <span style="color:#f1fa8c">&#34;name&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span> },{ <span style="color:#f1fa8c">&#34;name&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;indexname&#34;</span>, <span style="color:#f1fa8c">&#34;unique&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">true</span>,dropDups<span style="color:#ff79c6">:</span><span style="color:#ff79c6">true</span> })
</code></pre></div><h4 id="删除索引">删除索引</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.students.dropIndex(<span style="color:#f1fa8c">&#39;namedIndex&#39;</span>);<span style="color:#6272a4">//删除指定的索引
</span><span style="color:#6272a4"></span>db.students.dropIndex(<span style="color:#f1fa8c">&#39;*&#39;</span>);
db.runCommand({dropIndexes<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;students&#34;</span>,index<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;namedIndex&#34;</span>});<span style="color:#6272a4">//删除所有的索引
</span></code></pre></div><h4 id="在后台创建索引">在后台创建索引</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.students.ensureIndex({name<span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>},{name<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;nameIndex&#39;</span>,unique<span style="color:#ff79c6">:</span><span style="color:#ff79c6">true</span>,background<span style="color:#ff79c6">:</span><span style="color:#ff79c6">true</span>});
</code></pre></div><h4 id="过期索引">过期索引</h4>
<p>在一定的时间后会过期，过期后相应数据数据被删除,比如 session、日志、缓存和临时文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.stus.insert({time<span style="color:#ff79c6">:</span><span style="color:#ff79c6">new</span> <span style="color:#8be9fd;font-style:italic">Date</span>()});
db.stus.ensureIndex({time<span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>},{expireAfterSeconds<span style="color:#ff79c6">:</span><span style="color:#bd93f9">10</span>});
db.stus.find();
</code></pre></div><ol>
<li>索引字段的值必须Date对象，不能是其它类型比如时间戳</li>
<li>删除时间不精确，每60秒跑一次。删除也要时间，所以有误差。</li>
</ol>
<h4 id="全文索引">全文索引</h4>
<p>大篇幅的文章中搜索关键词,MongoDB为我们提供了全文索引</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">db.article.insert({content<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;I am a gir&#39;</span>});
db.article.insert({content<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;I am a boy&#39;</span>});
$text<span style="color:#ff79c6">:</span>表示要在全文索引中查东西
$search<span style="color:#ff79c6">:</span>后边跟查找的内容, 默认全部匹配
db.article.find({$text<span style="color:#ff79c6">:</span>{$search<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;boy&#39;</span>}});
db.article.find({$text<span style="color:#ff79c6">:</span>{$search<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;girl&#39;</span>}});
db.article.find({$text<span style="color:#ff79c6">:</span>{$search<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#39;boy girl&#39;</span>}});<span style="color:#6272a4">//多次查找，多个关键字为或的关系
</span><span style="color:#6272a4"></span>db.article.find({$text<span style="color:#ff79c6">:</span>{$search<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;a b&#34;</span>}});
db.article.find({$text<span style="color:#ff79c6">:</span>{$search<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;boy -girl&#34;</span>}}); <span style="color:#6272a4">// -表示取消
</span><span style="color:#6272a4"></span>db.article.find({$text<span style="color:#ff79c6">:</span>{$search<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;a \&#34;coco cola\&#34; b &#34;</span>}}); <span style="color:#6272a4">//支持转义符的,用\斜杠来转义
</span></code></pre></div><h4 id="索引使用的注意事项">索引使用的注意事项</h4>
<ul>
<li>1为正序 -1为倒序</li>
<li>索引虽然可以提升查询性能，但会降低插件性能，对于插入多查询少不要创索引</li>
<li>数据量不大时不需要使用索引。性能的提升并不明显，反而大大增加了内存和硬盘的消耗。</li>
<li>查询数据超过表数据量30%时，不要使用索引字段查询</li>
<li>排序工作的时候可以建立索引以提高排序速度</li>
<li>数字索引，要比字符串索引快的多</li>
</ul>
<h3 id="mongodb-复制副本集">MongoDB 复制（副本集）</h3>
<p><strong>MongoDB</strong>复制是将数据同步在多个服务器的过程。
复制提供了数据的冗余备份，并在多个服务器上存储数据副本，提高了数据的可用性， 并可以保证数据的安全性。
复制还允许您从硬件故障和服务中断中恢复数据。</p>
<h4 id="mongodb复制原理">MongoDB复制原理</h4>
<p>mongodb的复制至少需要两个节点。其中一个是主节点，负责处理客户端请求，其余的都是从节点，负责复制主节点上的数据。
mongodb各个节点常见的搭配方式为：一主一从、一主多从。
主节点记录在其上的所有操作oplog，从节点定期轮询主节点获取这些操作，然后对自己的数据副本执行这些操作，从而保证从节点的数据与主节点一致。</p>
<h4 id="流程">流程</h4>
<ol>
<li>一台活跃服务器和二个备份服务器</li>
<li>当活跃服务器出现故障，这时集群根据权重算法推选出出活跃服务器</li>
<li>当原来的主服务器恢复后又会变成从服务器</li>
</ol>
<h4 id="配置副本集">配置副本集</h4>
<p>A服务器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">dbpath<span style="color:#ff79c6">=</span>E<span style="color:#ff79c6">:</span>\repl\repl1
port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2001</span>
replSet<span style="color:#ff79c6">=</span>group
</code></pre></div><p>B服务器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">dbpath<span style="color:#ff79c6">=</span>E<span style="color:#ff79c6">:</span>\repl\repl2
port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2002</span>
replSet<span style="color:#ff79c6">=</span>group
</code></pre></div><p>C服务器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">dbpath<span style="color:#ff79c6">=</span>E<span style="color:#ff79c6">:</span>\repl\repl3
port<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2003</span>
replSet<span style="color:#ff79c6">=</span>group
</code></pre></div><h4 id="初始化副本集">初始化副本集</h4>
<p>rs.initiate() 启动一个新的副本集
rs.conf() 查看副本集的配置
rs.status() 命令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">use admin;
<span style="color:#8be9fd;font-style:italic">var</span> conf<span style="color:#ff79c6">=</span>
{
    <span style="color:#f1fa8c">&#34;_id&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;group&#34;</span>,
    <span style="color:#f1fa8c">&#34;members&#34;</span> <span style="color:#ff79c6">:</span> [
        { <span style="color:#f1fa8c">&#34;_id&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#bd93f9">0</span>,  <span style="color:#f1fa8c">&#34;host&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;127.0.0.1:2001&#34;</span>  },
        { <span style="color:#f1fa8c">&#34;_id&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#bd93f9">1</span>,  <span style="color:#f1fa8c">&#34;host&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;127.0.0.1:2002&#34;</span>  },
        { <span style="color:#f1fa8c">&#34;_id&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#bd93f9">2</span>,  <span style="color:#f1fa8c">&#34;host&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;127.0.0.1:2003&#34;</span>  }
    ]
}
rs.initiate(conf);
rs.status();
</code></pre></div><h4 id="高级参数">高级参数</h4>
<ul>
<li>standard 常规节点 参与投票有可能成为活跃节点</li>
<li>passive 副本节点 参与投票，但不能成为活跃节点</li>
<li>arbiter 仲裁节点 只参与投票，不复制节点，也不能成为活跃节点</li>
<li>priority 0到1000之间，0代表是副本节点，1到1000是常规节点</li>
<li>arbiterOnly:true 仲裁节点</li>
</ul>
<h4 id="读写分离操作">读写分离操作</h4>
<p>一般情况下作为副本节点是不能进行数据库操作的，但是在读取密集的系统中读写分离是必要的</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"> rs.slaveOk();
</code></pre></div><h4 id="oplog">Oplog</h4>
<p>它被存储在本地数据库local中，会记录每一个操作。 如果希望在故障恢复的时候尽可能更多，可以把这个size设置的大一点</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#ff79c6">--</span>oplogSize <span style="color:#bd93f9">1024</span>
use local;
 db.oplog.rs.find().limit(<span style="color:#bd93f9">2</span>);
</code></pre></div><p>MongoDB的副本集与我们常见的主从有所不同，主从在主机宕机后所有服务将停止，而副本集在主机宕机后，副本会接管主节点成为主节点，不会出现宕机的情况。</p>
<h3 id="mongodb-分片">MongoDB 分片</h3>
<h4 id="分片">分片</h4>
<p>在Mongodb里面存在另一种集群，就是分片技术,可以满足MongoDB数据量大量增长的需求。</p>
<p>当MongoDB存储海量的数据时，一台机器可能不足以存储数据，也可能不足以提供可接受的读写吞吐量。这时，我们就可以通过在多台机器上分割数据，使得数据库系统能存储和处理更多的数据。</p>
<h4 id="为什么使用分片">为什么使用分片</h4>
<ul>
<li>复制所有的写入操作到主节点</li>
<li>延迟的敏感数据会在主节点查询</li>
<li>单个副本集限制在12个节点</li>
<li>当请求量巨大时会出现内存不足。</li>
<li>本地磁盘不足</li>
<li>垂直扩展价格昂贵</li>
</ul>
<p>MongoDB分片
下图展示了在MongoDB中使用分片集群结构分布：</p>
<p><img src="https://img-1256541035.cos.ap-shanghai.myqcloud.com/imgs/mongodb-sharding.png" alt=""></p>
<p>上图中主要有如下所述三个主要组件：</p>
<ul>
<li>
<p><strong>Shard</strong>:
用于存储实际的数据块，实际生产环境中一个shard server角色可由几台机器组个一个replica set承担，防止主机单点故障</p>
</li>
<li>
<p><strong>Config Server</strong>:
mongod实例，存储了整个 ClusterMetadata，其中包括 chunk信息。</p>
</li>
<li>
<p><strong>Query Routers</strong>:
前端路由，客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用。</p>
</li>
</ul>
<h4 id="分片实例">分片实例</h4>
<p>分片结构端口分布如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">Shard Server <span style="color:#bd93f9">1</span>：<span style="color:#bd93f9">27020</span>
Shard Server <span style="color:#bd93f9">2</span>：<span style="color:#bd93f9">27021</span>
Shard Server <span style="color:#bd93f9">3</span>：<span style="color:#bd93f9">27022</span>
Shard Server <span style="color:#bd93f9">4</span>：<span style="color:#bd93f9">27023</span>
Config Server ：<span style="color:#bd93f9">27100</span>
Route Process：<span style="color:#bd93f9">40000</span>
</code></pre></div><p>步骤一：启动Shard Server</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">[root@<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">/</span>]# mkdir <span style="color:#ff79c6">-</span>p <span style="color:#ff79c6">/</span>www<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>shard<span style="color:#ff79c6">/</span>s0
[root@<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">/</span>]# mkdir <span style="color:#ff79c6">-</span>p <span style="color:#ff79c6">/</span>www<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>shard<span style="color:#ff79c6">/</span>s1
[root@<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">/</span>]# mkdir <span style="color:#ff79c6">-</span>p <span style="color:#ff79c6">/</span>www<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>shard<span style="color:#ff79c6">/</span>s2
[root@<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">/</span>]# mkdir <span style="color:#ff79c6">-</span>p <span style="color:#ff79c6">/</span>www<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>shard<span style="color:#ff79c6">/</span>s3
[root@<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">/</span>]# mkdir <span style="color:#ff79c6">-</span>p <span style="color:#ff79c6">/</span>www<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>shard<span style="color:#ff79c6">/</span>log
[root@<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">/</span>]# <span style="color:#ff79c6">/</span>usr<span style="color:#ff79c6">/</span>local<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>bin<span style="color:#ff79c6">/</span>mongod <span style="color:#ff79c6">--</span>port <span style="color:#bd93f9">27020</span> <span style="color:#ff79c6">--</span>dbpath<span style="color:#ff79c6">=</span>/www/mongoDB/shard/s0 --logpath=/www/mongoDB/shard/log/s0.log --logappend --fork
....
[root@<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">/</span>]# <span style="color:#ff79c6">/</span>usr<span style="color:#ff79c6">/</span>local<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>bin<span style="color:#ff79c6">/</span>mongod <span style="color:#ff79c6">--</span>port <span style="color:#bd93f9">27023</span> <span style="color:#ff79c6">--</span>dbpath<span style="color:#ff79c6">=</span>/www/mongoDB/shard/s3 --logpath=/www/mongoDB/shard/log/s3.log --logappend --fork
</code></pre></div><p>步骤二： 启动Config Server</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">[root@<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">/</span>]# mkdir <span style="color:#ff79c6">-</span>p <span style="color:#ff79c6">/</span>www<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>shard<span style="color:#ff79c6">/</span>config
[root@<span style="color:#bd93f9">100</span> <span style="color:#ff79c6">/</span>]# <span style="color:#ff79c6">/</span>usr<span style="color:#ff79c6">/</span>local<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>bin<span style="color:#ff79c6">/</span>mongod <span style="color:#ff79c6">--</span>port <span style="color:#bd93f9">27100</span> <span style="color:#ff79c6">--</span>dbpath<span style="color:#ff79c6">=</span>/www/mongoDB/shard/config --logpath=/www/mongoDB/shard/log/config.log --logappend --fork
</code></pre></div><p>注意：这里我们完全可以像启动普通mongodb服务一样启动，不需要添加—shardsvr和configsvr参数。因为这两个参数的作用就是改变启动端口的，所以我们自行指定了端口就可以。</p>
<p>步骤三： 启动Route Process</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">/usr/local/mongoDB/bin/mongos --port 40000 --configdb localhost:27100 --fork --logpath=/www/mongoDB/shard/log/route.log --chunkSize 500
</code></pre></div><p>mongos启动参数中，chunkSize这一项是用来指定chunk的大小的，单位是MB，默认大小为200MB.</p>
<p>步骤四： 配置Sharding</p>
<p>接下来，我们使用MongoDB Shell登录到mongos，添加Shard节点</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">[root@<span style="color:#bd93f9">100</span> shard]# <span style="color:#ff79c6">/</span>usr<span style="color:#ff79c6">/</span>local<span style="color:#ff79c6">/</span>mongoDB<span style="color:#ff79c6">/</span>bin<span style="color:#ff79c6">/</span>mongo admin <span style="color:#ff79c6">--</span>port <span style="color:#bd93f9">40000</span>
MongoDB shell version<span style="color:#ff79c6">:</span> <span style="color:#bd93f9">2.0.7</span>
connecting to<span style="color:#ff79c6">:</span> <span style="color:#bd93f9">127.0.0.1</span><span style="color:#ff79c6">:</span><span style="color:#bd93f9">40000</span><span style="color:#ff79c6">/</span>admin
mongos<span style="color:#ff79c6">&gt;</span> db.runCommand({ addshard<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;localhost:27020&#34;</span> })
{ <span style="color:#f1fa8c">&#34;shardAdded&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;shard0000&#34;</span>, <span style="color:#f1fa8c">&#34;ok&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#bd93f9">1</span> }
......
mongos<span style="color:#ff79c6">&gt;</span> db.runCommand({ addshard<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;localhost:27029&#34;</span> })
{ <span style="color:#f1fa8c">&#34;shardAdded&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;shard0009&#34;</span>, <span style="color:#f1fa8c">&#34;ok&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#bd93f9">1</span> }
mongos<span style="color:#ff79c6">&gt;</span> db.runCommand({ enablesharding<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;test&#34;</span> }) #设置分片存储的数据库
{ <span style="color:#f1fa8c">&#34;ok&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#bd93f9">1</span> }
mongos<span style="color:#ff79c6">&gt;</span> db.runCommand({ shardcollection<span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;test.log&#34;</span>, key<span style="color:#ff79c6">:</span> { id<span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>,time<span style="color:#ff79c6">:</span><span style="color:#bd93f9">1</span>}})
{ <span style="color:#f1fa8c">&#34;collectionsharded&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#f1fa8c">&#34;test.log&#34;</span>, <span style="color:#f1fa8c">&#34;ok&#34;</span> <span style="color:#ff79c6">:</span> <span style="color:#bd93f9">1</span> }
</code></pre></div><p>步骤五： 程序代码内无需太大更改，直接按照连接普通的mongo数据库那样，将数据库连接接入接口40000</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/database" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Database</a>
   </li>
  
   <li class="list">
     <a href="/tags/mongodb" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">MongoDB</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">What&#39;s in this posts</p>
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#mongodb通过配置项启动数据库">MongoDB通过配置项启动数据库</a></li>
        <li><a href="#导入导出数据">导入导出数据</a></li>
        <li><a href="#备份与恢复">备份与恢复</a></li>
        <li><a href="#锁定和解锁数据库">锁定和解锁数据库</a></li>
        <li><a href="#用户管理">用户管理</a></li>
        <li><a href="#数据库高级命令">数据库高级命令</a></li>
        <li><a href="#固定集合">固定集合</a></li>
        <li><a href="#索引">索引</a></li>
        <li><a href="#mongodb-复制副本集">MongoDB 复制（副本集）</a></li>
        <li><a href="#mongodb-分片">MongoDB 分片</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/2018/10/12/mongodb/">MongoDB 知识点梳理（一）</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://goyth.cn/" >
    &copy;  GOYTH 2020 
  </a>
    <div>




<a href="https://twitter.com/goythz" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>





<a href="https://github.com/jsyt" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>






</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
